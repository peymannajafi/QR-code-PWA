<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Building Information Model Hub</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FFFFFF">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/000000/ffffff?text=BIM">

    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

    <style>
        :root {
            --bg-main: #F4F7FC;
            --bg-panel: #FFFFFF;
            --text-primary: #1A202C;
            --text-secondary: #718096;
            --accent-primary: #4A90E2; /* A professional blue */
            --accent-secondary: #50E3C2; /* A vibrant mint for highlights */
            --border-color: #E2E8F0;
            --toast-success: #C6F6D5;
            --toast-error: #FED7D7;
            --text-success: #2F855A;
            --text-error: #C53030;
        }
        .dark {
             --bg-main: #1A202C;
             --bg-panel: #2D3748;
             --text-primary: #F7FAFC;
             --text-secondary: #A0AEC0;
             --border-color: #4A5568;
        }

        body { font-family: 'Ubuntu', sans-serif; background-color: var(--bg-main); color: var(--text-primary); }
        .persian { font-family: 'Vazirmatn', sans-serif; direction: rtl; }
        
        .panel-content { @apply hidden; }
        .panel-content.active { @apply block; }
        
        .btn { @apply w-full text-center py-3 px-6 rounded-lg font-semibold transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2; }
        .btn-primary { @apply bg-[var(--accent-primary)] text-white hover:opacity-90 focus:ring-[var(--accent-primary)]; }
        .btn-secondary { @apply bg-[var(--border-color)] text-[var(--text-primary)] hover:bg-opacity-80 focus:ring-[var(--text-secondary)]; }
        .btn:disabled { @apply bg-gray-300 dark:bg-gray-600 text-gray-500 dark:text-gray-400 cursor-not-allowed; }

        .input-field { @apply w-full border border-[var(--border-color)] rounded-lg py-2 px-4 bg-transparent focus:outline-none focus:ring-2 focus:ring-[var(--accent-primary)]; }
        .tab { @apply py-2 px-4 font-medium text-[var(--text-secondary)] border-b-2 border-transparent cursor-pointer; }
        .tab.active { @apply text-[var(--accent-primary)] border-[var(--accent-primary)]; }
        
        .skeleton { @apply bg-gray-200 dark:bg-gray-700 rounded-md animate-pulse; }
        .toast { @apply fixed bottom-5 right-5 p-4 rounded-xl shadow-lg transition-all duration-300 transform translate-y-[200%]; z-50; }
        .toast.show { @apply translate-y-0; }
        .toast.success { background-color: var(--toast-success); color: var(--text-success); }
        .toast.error { background-color: var(--toast-error); color: var(--text-error); }
    </style>
</head>
<body>

    <div class="flex h-screen">
        <!-- Sidebar / List Panel -->
        <aside id="list-panel" class="bg-[var(--bg-panel)] w-full md:w-1/3 lg:w-1/4 h-screen flex-col border-r border-[var(--border-color)] hidden md:flex">
            <header class="p-4 border-b border-[var(--border-color)]">
                <input type="search" id="search-bar" class="input-field" data-lang-placeholder="search">
            </header>
            <div id="building-list-container" class="p-4 space-y-3 overflow-y-auto">
                <!-- Skeleton Loader -->
                <div id="skeleton-loader">
                    <div class="h-16 skeleton"></div>
                    <div class="h-16 mt-3 skeleton"></div>
                    <div class="h-16 mt-3 skeleton"></div>
                </div>
                <!-- Building List -->
                <div id="building-list"></div>
                <!-- Empty State -->
                <div id="empty-state" class="text-center p-8 hidden">
                    <h3 class="font-bold text-lg" data-lang="no_buildings_title">No Buildings Yet</h3>
                    <p class="text-sm text-[var(--text-secondary)]" data-lang="no_buildings_desc">Click "Add Building" to get started.</p>
                </div>
            </div>
            <footer class="p-4 mt-auto border-t border-[var(--border-color)] grid grid-cols-2 gap-3">
                 <button class="btn btn-secondary !py-2" id="add-building-btn"><span data-lang="add_new_building">Add Building</span></button>
                 <button class="btn btn-secondary !py-2" id="scan-qr-btn"><span data-lang="scan_qr_code">Scan QR</span></button>
            </footer>
        </aside>

        <!-- Main Content Panel -->
        <main id="main-panel" class="flex-1 h-screen overflow-y-auto p-8">
            <!-- Home/Welcome Panel -->
            <div id="panel-home" class="panel-content active">
                 <h1 class="text-4xl font-bold" data-lang="home_title_1">Building Information Hub</h1>
                 <p class="text-lg text-[var(--text-secondary)] mt-2" data-lang="home_subtitle">Select a building or add a new one.</p>
            </div>
            
            <!-- Form Panel -->
            <div id="panel-form" class="panel-content">
                <form id="building-form" class="max-w-2xl mx-auto">
                    <input type="hidden" id="building-id">
                    <h1 class="text-3xl font-bold mb-6" data-lang="building_info">Building Information</h1>
                    <!-- Form Tabs -->
                    <div class="border-b border-[var(--border-color)] mb-6">
                        <nav class="-mb-px flex space-x-6 rtl:space-x-reverse">
                            <button type="button" class="tab active" data-tab="1" data-lang="tab_address">Address & Info</button>
                            <button type="button" class="tab" data-tab="2" data-lang="tab_property">Property Profile</button>
                            <button type="button" class="tab" data-tab="3" data-lang="tab_notes">Photos & Notes</button>
                        </nav>
                    </div>
                    <!-- Tab Content -->
                    <div id="tab-content" class="space-y-4">
                        <div class="tab-pane active" data-tab-pane="1">
                            <div class="input-group"><label class="font-medium mb-1 block" for="name" data-lang="name">Name *</label><input type="text" id="name" class="input-field" required></div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                <div class="input-group"><label class="font-medium mb-1 block" for="zipCode" data-lang="zip_code">ZIP/Postal Code</label><input type="text" id="zipCode" class="input-field"></div>
                                <div class="input-group"><label class="font-medium mb-1 block" for="address" data-lang="address">Address</label><input type="text" id="address" class="input-field"></div>
                            </div>
                        </div>
                        <div class="tab-pane hidden" data-tab-pane="2">
                             <div class="input-group"><label class="font-medium mb-1 block" for="area" data-lang="area">Area (sqm)</label><input type="number" id="area" class="input-field"></div>
                        </div>
                         <div class="tab-pane hidden" data-tab-pane="3">
                             <div class="input-group"><label class="font-medium mb-1 block" for="notes" data-lang="notes">Notes</label><textarea id="notes" class="input-field"></textarea></div>
                        </div>
                    </div>
                    <div class="flex justify-end gap-4 mt-8">
                        <button type="button" id="cancel-form-btn" class="btn btn-secondary" data-lang="cancel">Cancel</button>
                        <button type="submit" id="save-form-btn" class="btn btn-primary" data-lang="save">Save</button>
                    </div>
                </form>
            </div>
            
            <!-- Detail Panel -->
            <div id="panel-detail" class="panel-content"></div>

            <!-- Mobile Only - Full list view -->
             <div id="panel-list-mobile" class="panel-content md:hidden"></div>

        </main>
    </div>

     <!-- Toast Notification -->
    <div id="toast-notification" class="toast"></div>

    <script>
        (async () => {
            const mainPanel = document.getElementById('main-panel');
            const listPanel = document.getElementById('list-panel');
            const panels = { home: document.getElementById('panel-home'), form: document.getElementById('panel-form'), detail: document.getElementById('panel-detail'), list: document.getElementById('panel-list-mobile') };
            const buildingListEl = document.getElementById('building-list');
            const buildingFormEl = document.getElementById('building-form');
            const saveFormBtn = document.getElementById('save-form-btn');
            const skeletonLoader = document.getElementById('skeleton-loader');
            const emptyState = document.getElementById('empty-state');
            const toast = document.getElementById('toast-notification');
            let db, currentLanguage = 'en', activeBuildingId = null;

            const translations = {
                en: { home_title_1: "Building Information Hub", home_subtitle: "Select a building or add a new one.", add_new_building: "Add Building", building_info: "Building Information", name: "Name", zip_code: "ZIP/Postal Code", address: "Address", area: "Area (sqm)", notes: "Notes", save: "Save", cancel: "Cancel", search: "Search...", building_detail: "Building Detail", no_buildings_title: "No Buildings Yet", no_buildings_desc: "Click \"Add Building\" to get started.", building_saved: "Building saved!", scan_qr_code: "Scan QR", tab_address: "Address & Info", tab_property: "Property Profile", tab_notes: "Photos & Notes" },
                fa: { home_title_1: "مرکز اطلاعات ساختمان", home_subtitle: "یک ساختمان را انتخاب یا یک ساختمان جدید اضافه کنید.", add_new_building: "افزودن ساختمان", building_info: "اطلاعات ساختمان", name: "نام", zip_code: "کد پستی", address: "آدرس", area: "مساحت (مترمربع)", notes: "یادداشت", save: "ذخیره", cancel: "انصراف", search: "جستجو...", building_detail: "جزئیات ساختمان", no_buildings_title: "ساختمانی وجود ندارد", no_buildings_desc: "برای شروع، روی «افزودن ساختمان» کلیک کنید.", building_saved: "ساختمان ذخیره شد!", scan_qr_code: "اسکن QR", tab_address: "آدرس و اطلاعات", tab_property: "مشخصات ملک", tab_notes: "عکس و یادداشت" }
            };

            const initDB = () => new Promise(r => {
                const req = indexedDB.open('BIMHub_Pro_v1', 1);
                req.onupgradeneeded = e => e.target.result.createObjectStore('buildings', { keyPath: 'id', autoIncrement: true });
                req.onsuccess = e => { db = e.target.result; r(); };
            });

            const showToast = (messageKey, type = 'success') => {
                toast.textContent = translations[currentLanguage][messageKey] || messageKey;
                toast.className = `toast ${type} show`;
                setTimeout(() => toast.classList.remove('show'), 3000);
            };

            const switchPanel = (panelId) => {
                Object.values(panels).forEach(p => p.classList.remove('active'));
                if (panels[panelId]) {
                    panels[panelId].classList.add('active');
                    if (panelId === 'form') document.getElementById('name').focus();
                }
            };
            
            const updateLanguage = () => {
                document.body.className = currentLanguage === 'fa' ? 'persian' : 'ltr';
                const lang = translations[currentLanguage];
                document.querySelectorAll('[data-lang]').forEach(el => el.textContent = lang[el.dataset.lang]);
                document.querySelectorAll('[data-lang-placeholder]').forEach(el => el.placeholder = lang[el.dataset.langPlaceholder]);
            };

            const renderBuildingList = async (filter = '') => {
                 skeletonLoader.style.display = 'block';
                 buildingListEl.style.display = 'none';
                 emptyState.style.display = 'none';

                 const buildings = await new Promise(r => db.transaction('buildings').objectStore('buildings').getAll().onsuccess = e => r(e.target.result));
                 
                 skeletonLoader.style.display = 'none';
                 buildingListEl.innerHTML = '';
                 const lowerFilter = filter.toLowerCase();
                 const filtered = buildings.filter(b => b.name?.toLowerCase().includes(lowerFilter) || b.zipCode?.toLowerCase().includes(lowerFilter));
                
                if (filtered.length === 0) {
                    emptyState.style.display = 'block';
                } else {
                    buildingListEl.style.display = 'block';
                    filtered.forEach(b => {
                        const item = document.createElement('div');
                        item.className = `p-3 rounded-lg cursor-pointer border-2 border-transparent transition-all ${b.id === activeBuildingId ? 'bg-[var(--bg-accent)] border-[var(--accent-primary)]' : 'hover:bg-gray-100 dark:hover:bg-gray-700'}`;
                        item.dataset.id = b.id;
                        item.innerHTML = `<h4 class="font-bold">${b.name}</h4><p class="text-sm text-[var(--text-secondary)]">${b.zipCode || ''}</p>`;
                        item.addEventListener('click', () => displayBuildingDetail(b.id));
                        buildingListEl.appendChild(item);
                    });
                }
            };

            const displayBuildingDetail = async (id) => {
                const building = await new Promise(r => db.transaction('buildings').objectStore('buildings').get(id).onsuccess = e => r(e.target.result));
                activeBuildingId = id;
                renderBuildingList(document.getElementById('search-bar').value); // Re-render list to show active state
                const detailEl = document.getElementById('panel-detail');
                detailEl.innerHTML = '';
                if(building) {
                    const content = `
                        <h1 class="text-3xl font-bold">${building.name}</h1>
                        <p class="text-lg text-[var(--text-secondary)]">${building.address || ''}</p>
                        <div class="mt-8 grid grid-cols-2 gap-6">
                            <div><h5 class="text-sm text-[var(--text-secondary)]" data-lang="zip_code">ZIP</h5><p class="font-bold text-lg">${building.zipCode || 'N/A'}</p></div>
                            <div><h5 class="text-sm text-[var(--text-secondary)]" data-lang="area">Area</h5><p class="font-bold text-lg">${building.area || 'N/A'} sqm</p></div>
                        </div>
                         <div class="mt-6"><h5 class="text-sm text-[var(--text-secondary)]" data-lang="notes">Notes</h5><p>${building.notes || 'No notes available.'}</p></div>
                    `;
                    detailEl.innerHTML = content;
                }
                switchPanel('detail');
                updateLanguage();
            };

            const openForm = async (id = null) => {
                buildingFormEl.reset();
                if (id) {
                    const building = await new Promise(r => db.transaction('buildings').objectStore('buildings').get(id).onsuccess = e => r(e.target.result));
                    Object.keys(building).forEach(key => {
                        const el = document.getElementById(key);
                        if(el) el.value = building[key];
                    });
                }
                validateForm();
                switchPanel('form');
            };

            const validateForm = () => saveFormBtn.disabled = !document.getElementById('name').value.trim();
            document.getElementById('name').addEventListener('input', validateForm);

            document.getElementById('add-building-btn').addEventListener('click', () => openForm());
            document.getElementById('cancel-form-btn').addEventListener('click', () => switchPanel('home'));
            document.getElementById('search-bar').addEventListener('input', e => renderBuildingList(e.target.value));
            
            // Tab switching logic
            buildingFormEl.querySelector('.flex.space-x-6').addEventListener('click', e => {
                if(e.target.matches('.tab')) {
                    const tabNum = e.target.dataset.tab;
                    buildingFormEl.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                    buildingFormEl.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));
                    buildingFormEl.querySelector(`.tab-pane[data-tab-pane="${tabNum}"]`).classList.remove('hidden');
                }
            });

            buildingFormEl.addEventListener('submit', async e => {
                e.preventDefault();
                const data = Object.fromEntries(new FormData(e.target).entries());
                const id = parseInt(document.getElementById('building-id').value);
                if(id) data.id = id;
                
                const tx = db.transaction('buildings', 'readwrite');
                const req = tx.objectStore('buildings').put(data);
                req.onsuccess = async () => {
                    await renderBuildingList();
                    displayBuildingDetail(req.result);
                    showToast('building_saved', 'success');
                };
            });
            
            await initDB();
            await renderBuildingList();
            updateLanguage();
        })();
    </script>

</body>
</html>
