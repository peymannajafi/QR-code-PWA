<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Building Info</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- QR Code Generation and Scanning libraries -->
    <script src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .page { display: none; }
        .page.active { display: block; }
        #qr-reader-container { width: 100%; max-width: 500px; margin: 0 auto; border-radius: 1rem; overflow: hidden; border: 4px solid #0d9488; }
        /* Loading spinner */
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #0d9488; width: 40px; height: 40px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Main Application Container -->
    <div id="app" class="max-w-4xl mx-auto">
        <!-- Header -->
        <header class="bg-teal-700 text-white shadow-md sticky top-0 z-50">
            <div class="mx-auto px-4 py-4 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <svg id="back-button" class="w-6 h-6 cursor-pointer hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    <h1 id="header-title" class="text-xl font-bold">Building Information Hub</h1>
                </div>
                <div id="header-actions"></div>
            </div>
        </header>

        <main class="p-4 md:p-6">
            <!-- Configuration Error Message -->
            <div id="config-error" class="hidden text-center p-6 bg-red-100 border border-red-400 text-red-700 rounded-lg">
                <!-- Error content will be injected here by JavaScript -->
            </div>

            <!-- Loading Indicator -->
            <div id="loading-indicator" class="flex justify-center items-center mt-20">
                <div class="loader"></div>
            </div>

            <!-- ========== PAGES (Initially hidden) ========== -->
            <div id="pages-container" class="hidden">
                <!-- 1. Home Page -->
                <div id="page-home" class="page active">
                    <div class="flex flex-col space-y-4 max-w-sm mx-auto mt-16 text-center">
                        <button data-target="page-scanner" class="nav-button bg-teal-600 hover:bg-teal-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg flex items-center justify-center space-x-3">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                            <span>Scan Building QR Code</span>
                        </button>
                        <button data-target="page-admin" class="nav-button bg-gray-700 hover:bg-gray-800 text-white font-bold py-4 px-6 rounded-lg shadow-lg flex items-center justify-center space-x-3">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            <span>Admin Panel</span>
                        </button>
                    </div>
                </div>

                <!-- 2. Admin Page -->
                <div id="page-admin" class="page">
                    <div id="building-list" class="space-y-3"></div>
                    <div id="empty-admin-state" class="text-center mt-16 text-gray-500 hidden">
                        <p>No buildings found.</p>
                        <p>Click the '+' button to add one.</p>
                    </div>
                </div>

                <!-- 3. Building Form Page -->
                <div id="page-form" class="page">
                    <form id="building-form" class="space-y-4">
                        <input type="hidden" id="building-id">
                        <div>
                            <label for="buildingName" class="block text-sm font-medium text-gray-700">Building Name *</label>
                            <input type="text" id="buildingName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500">
                        </div>
                        <div>
                            <label for="address" class="block text-sm font-medium text-gray-700">Address / Location</label>
                            <input type="text" id="address" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500">
                        </div>
                        <div>
                            <label for="yearBuilt" class="block text-sm font-medium text-gray-700">Year Built</label>
                            <input type="number" id="yearBuilt" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500">
                        </div>
                        <div>
                            <label for="buildingUseType" class="block text-sm font-medium text-gray-700">Building Use Type</label>
                            <input type="text" id="buildingUseType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500">
                        </div>
                        <div>
                            <label for="ownerName" class="block text-sm font-medium text-gray-700">Owner Name (Optional)</label>
                            <input type="text" id="ownerName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500">
                        </div>
                        <div>
                            <label for="notes" class="block text-sm font-medium text-gray-700">Notes</label>
                            <textarea id="notes" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500"></textarea>
                        </div>
                    </form>
                </div>

                <!-- 4. Building Detail Page -->
                <div id="page-detail" class="page">
                    <div id="detail-content" class="space-y-3"></div>
                </div>

                <!-- 5. QR Scanner Page -->
                <div id="page-scanner" class="page">
                    <div id="qr-reader-container">
                        <div id="qr-reader"></div>
                    </div>
                    <p class="text-center text-gray-500 mt-4">Point your camera at a QR code.</p>
                </div>
            </div>
        </main>
        
        <!-- Global Toast/Notification -->
        <div id="toast" class="fixed bottom-5 right-5 bg-gray-900 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300 opacity-0">
            <p id="toast-message"></p>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
        
        // --- 1. PASTE YOUR FIREBASE CONFIGURATION HERE ---
        const firebaseConfig = {
          apiKey: "AIzaSyCJ3pxpHyIp8DxSLcK9xdyQfxskFqJQq_Y",
          authDomain: "qr-code-soheil-online.firebaseapp.com",
          projectId: "qr-code-soheil-online",
          storageBucket: "qr-code-soheil-online.firebasestorage.app",
          messagingSenderId: "874584054880",
          appId: "1:874584054880:web:b558d97d56ae13e07d7705",
          measurementId: "G-LCD56T8MED"
        };
        // ----------------------------------------------------

        // --- APPLICATION LOGIC (DO NOT EDIT BELOW THIS LINE) ---

        // Helper function to show a visible error if config is missing
        function checkConfig() {
            const configErrorContainer = document.getElementById('config-error');
            const loadingIndicator = document.getElementById('loading-indicator');
            if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY") {
                loadingIndicator.style.display = 'none';
                configErrorContainer.style.display = 'block';
                configErrorContainer.innerHTML = `
                    <h2 class="text-2xl font-bold mb-4">Configuration Required</h2>
                    <p>Your Firebase configuration is missing.</p>
                    <p class="mt-2">Please create a Firebase project, get your web app configuration, and paste it into the <code>firebaseConfig</code> object in this HTML file.</p>
                    <a href="https://console.firebase.google.com/" target="_blank" rel="noopener noreferrer" class="inline-block mt-4 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">
                        Go to Firebase Console
                    </a>
                `;
                return false;
            }
            return true;
        }

        if (checkConfig()) {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const firestoreDb = getFirestore(app);
            
            const state = {
                currentPage: 'page-home',
                history: [],
                activeScanner: null,
                localBuildingsCache: [],
                unsubscribe: null, // To stop listening to DB updates when needed
            };

            const pagesContainer = document.getElementById('pages-container');
            const loadingIndicator = document.getElementById('loading-indicator');
            const pages = document.querySelectorAll('.page');
            const headerTitle = document.getElementById('header-title');
            const backButton = document.getElementById('back-button');
            const headerActions = document.getElementById('header-actions');
            const buildingList = document.getElementById('building-list');
            const emptyAdminState = document.getElementById('empty-admin-state');
            const form = document.getElementById('building-form');

            // --- DATABASE LOGIC (using Firestore) ---
            const db = {
                uuid: () => doc(collection(firestoreDb, 'temp')).id,
                getById: (id) => state.localBuildingsCache.find(b => b.id === id),
                save: async (buildingData) => {
                    const docRef = doc(firestoreDb, 'buildings', buildingData.id);
                    await setDoc(docRef, buildingData, { merge: true });
                },
                delete: async (id) => {
                    const docRef = doc(firestoreDb, 'buildings', id);
                    await deleteDoc(docRef);
                },
                listenToChanges: (callback) => {
                    const buildingsCol = collection(firestoreDb, 'buildings');
                    state.unsubscribe = onSnapshot(buildingsCol, (querySnapshot) => {
                        const buildings = [];
                        querySnapshot.forEach((doc) => {
                            buildings.push({ id: doc.id, ...doc.data() });
                        });
                        state.localBuildingsCache = buildings;
                        callback(buildings);
                    });
                }
            };

            // --- UI RENDERING ---
            const ui = {
                renderAdminList: (buildings) => {
                    buildingList.innerHTML = '';
                    emptyAdminState.classList.toggle('hidden', buildings.length > 0);
                    buildings.forEach(building => {
                        const item = document.createElement('div');
                        item.className = 'bg-white p-4 rounded-lg shadow hover:bg-gray-50 cursor-pointer';
                        item.dataset.id = building.id;
                        item.innerHTML = `<h3 class="font-bold text-lg">${building.buildingName}</h3><p class="text-gray-600">${building.address || 'No address'}</p>`;
                        item.addEventListener('click', () => showPage('page-detail', { buildingId: building.id }));
                        buildingList.appendChild(item);
                    });
                },
                renderDetail: (building, isAdminView) => {
                    const content = document.getElementById('detail-content');
                    content.innerHTML = '';
                    const fields = [
                        { label: 'Building Name', value: building.buildingName },
                        { label: 'Address', value: building.address },
                        { label: 'Year Built', value: building.yearBuilt },
                        { label: 'Use Type', value: building.buildingUseType },
                        { label: 'Owner Name', value: building.ownerName },
                        { label: 'Notes', value: building.notes },
                    ];
                    fields.forEach(field => {
                        const row = document.createElement('div');
                        row.className = 'bg-white p-4 rounded-lg shadow';
                        row.innerHTML = `<p class="text-sm font-bold text-teal-600">${field.label}</p><p class="text-lg mt-1">${field.value || 'N/A'}</p>`;
                        content.appendChild(row);
                    });

                    if (isAdminView) {
                        const qrCard = document.createElement('div');
                        qrCard.className = 'bg-white p-6 rounded-lg shadow text-center mt-4';
                        qrCard.innerHTML = `<h3 class="text-lg font-bold text-teal-700 mb-2">Building QR Code</h3><div id="detail-qr-code-container" class="mt-4 flex justify-center"></div><div class="mt-6"><button id="detail-download-qr-button" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg">Download QR Code</button></div>`;
                        content.appendChild(qrCard);
                        const qrCode = new QRCodeStyling({ width: 250, height: 250, data: building.id, dotsOptions: { color: '#0d9488', type: 'rounded' }, backgroundOptions: { color: '#ffffff' }, cornersSquareOptions: { color: '#0f766e', type: 'extra-rounded' }, cornersDotOptions: { color: '#0f766e', type: 'dot' } });
                        qrCode.append(document.getElementById('detail-qr-code-container'));
                        document.getElementById('detail-download-qr-button').onclick = () => qrCode.download({ name: `qr-${building.buildingName.replace(/\s+/g, '-')}`, extension: 'png' });
                    }
                },
                showToast: (message, isError = false) => {
                    const toast = document.getElementById('toast');
                    const toastMessage = document.getElementById('toast-message');
                    toastMessage.textContent = message;
                    toast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300 opacity-100 ${isError ? 'bg-red-600' : 'bg-gray-900'}`;
                    setTimeout(() => toast.classList.replace('opacity-100', 'opacity-0'), 3000);
                }
            };

            // --- PAGE NAVIGATION & HEADER CONTROL ---
            const showPage = (pageId, params = {}) => {
                if (state.activeScanner) { state.activeScanner.stop().catch(err => {}); state.activeScanner = null; }
                if (state.currentPage !== pageId) state.history.push(state.currentPage);
                state.currentPage = pageId;
                pages.forEach(p => p.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');
                backButton.classList.toggle('hidden', pageId === 'page-home');
                headerActions.innerHTML = '';

                switch(pageId) {
                    case 'page-home':
                        headerTitle.textContent = 'Building Info Hub';
                        state.history = [];
                        break;
                    case 'page-admin':
                        headerTitle.textContent = 'Admin: Records';
                        headerActions.innerHTML = `<div class="flex items-center space-x-2"><button id="add-building-btn" class="p-2 rounded-full hover:bg-teal-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg></button></div>`;
                        document.getElementById('add-building-btn').onclick = () => showPage('page-form');
                        break;
                    case 'page-form':
                        headerTitle.textContent = params.buildingId ? 'Edit Building' : 'Add Building';
                        headerActions.innerHTML = `<button id="save-btn" class="p-2 rounded-full hover:bg-teal-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></button>`;
                        document.getElementById('save-btn').onclick = handleFormSave;
                        form.reset();
                        if (params.buildingId) {
                            const building = db.getById(params.buildingId);
                            if (building) {
                                document.getElementById('building-id').value = building.id;
                                document.getElementById('buildingName').value = building.buildingName;
                                document.getElementById('address').value = building.address;
                                document.getElementById('yearBuilt').value = building.yearBuilt;
                                document.getElementById('buildingUseType').value = building.buildingUseType;
                                document.getElementById('ownerName').value = building.ownerName;
                                document.getElementById('notes').value = building.notes;
                            }
                        } else {
                            document.getElementById('building-id').value = db.uuid();
                        }
                        break;
                    case 'page-detail':
                        const building = db.getById(params.buildingId);
                        if (building) {
                            headerTitle.textContent = building.buildingName;
                            const fromAdmin = state.history.at(-1) === 'page-admin';
                            if (fromAdmin) {
                                headerActions.innerHTML = `<div class="flex items-center space-x-2"><button id="edit-btn" class="p-2 rounded-full hover:bg-teal-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z"></path></svg></button><button id="delete-btn" class="p-2 rounded-full hover:bg-red-500"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></div>`;
                                document.getElementById('edit-btn').onclick = () => showPage('page-form', { buildingId: building.id });
                                document.getElementById('delete-btn').onclick = () => handleDelete(building.id);
                            }
                            ui.renderDetail(building, fromAdmin);
                        }
                        break;
                    case 'page-scanner':
                        headerTitle.textContent = 'Scan QR Code';
                        startScanner();
                        break;
                }
            };
            
            const goBack = () => { if (state.history.length > 0) { const p = state.history.pop(); state.currentPage = p; showPage(p, {}, true); } };
            backButton.addEventListener('click', goBack);
            document.querySelectorAll('.nav-button').forEach(btn => btn.addEventListener('click', () => showPage(btn.dataset.target)));
            const handleFormSave = async () => {
                if (!form.checkValidity()) { ui.showToast('Please fill in all required fields.', true); return; }
                const buildingData = { id: document.getElementById('building-id').value, buildingName: document.getElementById('buildingName').value, address: document.getElementById('address').value, yearBuilt: document.getElementById('yearBuilt').value, buildingUseType: document.getElementById('buildingUseType').value, ownerName: document.getElementById('ownerName').value, notes: document.getElementById('notes').value };
                await db.save(buildingData);
                ui.showToast('Building saved successfully!');
                goBack();
            };
            const handleDelete = (id) => { if (confirm('Are you sure?')) { db.delete(id); ui.showToast('Building deleted.'); goBack(); } };
            const startScanner = () => {
                const html5QrCode = new Html5Qrcode("qr-reader");
                state.activeScanner = html5QrCode;
                const qrSuccess = (id) => { html5QrCode.stop(); const b = db.getById(id); if (b) showPage('page-detail', { buildingId: id }); else { ui.showToast('Building not found.', true); goBack(); } };
                html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, qrSuccess).catch(err => ui.showToast("Could not start camera.", true));
            };

            // --- AUTH & INITIALIZATION ---
            onAuthStateChanged(auth, user => {
                if (user) {
                    db.listenToChanges(ui.renderAdminList);
                    loadingIndicator.classList.add('hidden');
                    pagesContainer.classList.remove('hidden');
                    showPage('page-home');
                }
            });
            signInAnonymously(auth).catch(error => {
                console.error("Firebase Connection Error:", error);
                const configErrorContainer = document.getElementById('config-error');
                const loadingIndicator = document.getElementById('loading-indicator');
                const pagesContainer = document.getElementById('pages-container');

                // Hide main content and show a specific error message
                loadingIndicator.style.display = 'none';
                pagesContainer.style.display = 'none';
                configErrorContainer.style.display = 'block';

                let baseErrorMessage = `
                    <p class="mt-4 font-semibold">Also, please double-check that:</p>
                    <ul class="list-disc list-inside mt-2 text-left max-w-md mx-auto">
                        <li>The <code>firebaseConfig</code> values in the HTML are an exact match for your project's config.</li>
                        <li>The project ID (<code>${firebaseConfig.projectId || 'not found'}</code>) is correct.</li>
                    </ul>
                    <a href="https://console.firebase.google.com/" target="_blank" rel="noopener noreferrer" class="inline-block mt-4 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">
                        Go to Firebase Console
                    </a>
                `;

                if (error.code === 'auth/configuration-not-found') {
                    configErrorContainer.innerHTML = `
                        <h2 class="text-2xl font-bold mb-4">Action Required</h2>
                        <p class="font-bold text-lg">Error: Anonymous Sign-in is not enabled.</p>
                        <p class="mt-2">This is the most common setup issue. To fix it:</p>
                        <ol class="list-decimal list-inside mt-2 text-left max-w-md mx-auto space-y-1">
                            <li>Go to your Firebase Console.</li>
                            <li>In the "Build" menu, click <b>Authentication</b>.</li>
                            <li>Click the <b>"Get started"</b> button.</li>
                            <li>From the list of Sign-in providers, click on <b>Anonymous</b> and <b>enable</b> it.</li>
                        </ol>
                    ` + baseErrorMessage;
                } else {
                     configErrorContainer.innerHTML = `
                        <h2 class="text-2xl font-bold mb-4">Connection Failed</h2>
                        <p class="font-bold text-lg">Error: ${error.code}</p>
                    ` + baseErrorMessage;
                    ui.showToast(`Error: ${error.message}`, true);
                }
            });
        }
    </script>
</body>
</html>
