<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Building Information Hub</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Theme and Icons for PWA -->
    <meta name="theme-color" content="#2c3e50">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/2c3e50/ffffff?text=BIM">

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- External Libraries -->
    <!-- QR Code Generation -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <!-- QR Code Scanning -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <!-- Excel (XLSX) Import/Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* Custom styles for a better look and feel */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .persian {
            font-family: 'Vazirmatn', sans-serif;
            direction: rtl;
        }
        .btn { @apply text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300; }
        .btn-primary { @apply bg-blue-600 hover:bg-blue-700; }
        .btn-secondary { @apply bg-gray-600 hover:bg-gray-700; }
        .btn-success { @apply bg-green-600 hover:bg-green-700; }
        .btn-danger { @apply bg-red-600 hover:bg-red-700; }
        .card { @apply bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden; }
        .page { @apply hidden; }
        .page.active { @apply block; }
        #scanner-video {
            width: 100%;
            height: auto;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">

    <div id="app-container" class="max-w-4xl mx-auto p-4">

        <!-- Header -->
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-blue-600 dark:text-blue-400" data-lang="app_title">Building Info Hub</h1>
            <div class="flex items-center space-x-4">
                <button id="scan-qr-btn" class="btn btn-secondary" data-lang="scan_qr_code">Scan QR</button>
                <button id="toggle-lang-btn" class="btn btn-secondary">ðŸ‡®ðŸ‡· / ðŸ‡¬ðŸ‡§</button>
            </div>
        </header>

        <!-- Main Content -->
        <main>
            <!-- Page: Building List -->
            <div id="page-list" class="page active">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                    <div class="relative w-full md:w-1/2">
                        <input type="search" id="search-bar" class="w-full p-2 pl-10 rounded-lg bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" data-lang-placeholder="search_by_zip">
                        <svg class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                    <button id="add-building-btn" class="btn btn-primary w-full md:w-auto" data-lang="add_new_building">Add New Building</button>
                </div>
                <div class="flex justify-center md:justify-start gap-2 mb-4">
                    <button id="import-excel-btn" class="btn btn-success text-sm" data-lang="import_excel">Import Excel</button>
                    <button id="export-excel-btn" class="btn btn-success text-sm" data-lang="export_excel">Export Excel</button>
                </div>

                <div id="building-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Building cards will be injected here -->
                </div>
                 <p id="empty-list-msg" class="text-center text-gray-500 mt-8" data-lang="no_buildings_found">No buildings found. Add one to get started!</p>
            </div>

            <!-- Page: Building Form (Add/Edit) -->
            <div id="page-form" class="page">
                <h2 id="form-title" class="text-2xl font-bold mb-4" data-lang="add_new_building">Add New Building</h2>
                <form id="building-form" class="space-y-4">
                    <input type="hidden" id="building-id">
                    <div>
                        <label for="building-name" class="block mb-1 font-medium" data-lang="building_name">Building Name</label>
                        <input type="text" id="building-name" class="w-full p-2 rounded-lg bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600" required>
                    </div>
                    <div>
                        <label for="address" class="block mb-1 font-medium" data-lang="address">Address</label>
                        <input type="text" id="address" class="w-full p-2 rounded-lg bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600" required>
                    </div>
                    <div>
                        <label for="zip-code" class="block mb-1 font-medium" data-lang="zip_code">Postal / Zip Code</label>
                        <input type="text" id="zip-code" class="w-full p-2 rounded-lg bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600" required>
                    </div>
                    <div>
                        <label for="notes" class="block mb-1 font-medium" data-lang="notes">Notes</label>
                        <textarea id="notes" rows="4" class="w-full p-2 rounded-lg bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600"></textarea>
                    </div>
                    <div>
                        <label for="photo" class="block mb-1 font-medium" data-lang="photo">Photo</label>
                        <input type="file" id="photo" accept="image/*" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        <img id="photo-preview" class="mt-4 rounded-lg max-h-60" src="" alt="Photo preview">
                    </div>
                     <div>
                        <label class="block mb-1 font-medium" data-lang="location">Location</label>
                        <div class="flex items-center gap-4">
                            <button type="button" id="get-location-btn" class="btn btn-secondary" data-lang="capture_location">Capture Location</button>
                            <span id="location-display" class="text-sm text-gray-500"></span>
                        </div>
                    </div>
                    <div class="flex justify-end gap-4 pt-4">
                        <button type="button" id="cancel-form-btn" class="btn btn-secondary" data-lang="cancel">Cancel</button>
                        <button type="submit" class="btn btn-primary" data-lang="save">Save</button>
                    </div>
                </form>
            </div>

            <!-- Page: Building Detail View -->
            <div id="page-detail" class="page">
                <div id="detail-content" class="card p-6">
                    <!-- Details will be injected here -->
                </div>
                <div class="mt-6 flex flex-wrap justify-center gap-4">
                    <button id="back-to-list-btn" class="btn btn-secondary" data-lang="back_to_list">Back to List</button>
                    <button id="edit-building-btn" class="btn btn-primary" data-lang="edit">Edit</button>
                    <button id="delete-building-btn" class="btn btn-danger" data-lang="delete">Delete</button>
                    <button id="export-pdf-btn" class="btn btn-success" data-lang="export_pdf">Export PDF</button>
                </div>
            </div>
            
            <!-- Page: QR Scanner -->
            <div id="page-scanner" class="page text-center">
                 <h2 class="text-2xl font-bold mb-4" data-lang="scan_qr_code">Scan QR Code</h2>
                 <p class="mb-4" data-lang="scan_instruction">Point your camera at a building's QR code.</p>
                 <div class="relative w-full max-w-md mx-auto aspect-square bg-gray-700 rounded-lg overflow-hidden">
                     <video id="scanner-video" playsinline></video>
                     <div class="absolute top-0 left-0 w-full h-full" style="box-shadow: inset 0 0 0 4px white;"></div>
                 </div>
                 <button id="cancel-scan-btn" class="btn btn-secondary mt-6" data-lang="cancel">Cancel</button>
            </div>
        </main>
    </div>

    <script>
        // Use a self-invoking async function to encapsulate the app logic
        (async () => {
            // --- DOM ELEMENT REFERENCES ---
            const appContainer = document.getElementById('app-container');
            const pages = {
                list: document.getElementById('page-list'),
                form: document.getElementById('page-form'),
                detail: document.getElementById('page-detail'),
                scanner: document.getElementById('page-scanner'),
            };
            // List Page
            const buildingList = document.getElementById('building-list');
            const addBuildingBtn = document.getElementById('add-building-btn');
            const searchBar = document.getElementById('search-bar');
            const emptyListMsg = document.getElementById('empty-list-msg');
            // Form Page
            const buildingForm = document.getElementById('building-form');
            const formTitle = document.getElementById('form-title');
            const cancelFormBtn = document.getElementById('cancel-form-btn');
            const buildingIdInput = document.getElementById('building-id');
            const buildingNameInput = document.getElementById('building-name');
            const addressInput = document.getElementById('address');
            const zipCodeInput = document.getElementById('zip-code');
            const notesInput = document.getElementById('notes');
            const photoInput = document.getElementById('photo');
            const photoPreview = document.getElementById('photo-preview');
            const getLocationBtn = document.getElementById('get-location-btn');
            const locationDisplay = document.getElementById('location-display');
            // Detail Page
            const detailContent = document.getElementById('detail-content');
            const backToListBtn = document.getElementById('back-to-list-btn');
            const editBuildingBtn = document.getElementById('edit-building-btn');
            const deleteBuildingBtn = document.getElementById('delete-building-btn');
            const exportPdfBtn = document.getElementById('export-pdf-btn');
            // Scanner Page
            const scanQrBtn = document.getElementById('scan-qr-btn');
            const scannerVideo = document.getElementById('scanner-video');
            const cancelScanBtn = document.getElementById('cancel-scan-btn');
            // Import/Export
            const importExcelBtn = document.getElementById('import-excel-btn');
            const exportExcelBtn = document.getElementById('export-excel-btn');
            // Language
            const toggleLangBtn = document.getElementById('toggle-lang-btn');

            // --- STATE MANAGEMENT ---
            let db;
            let currentBuildingId = null;
            let currentLocation = null;
            let currentPhotoData = null;
            let currentLanguage = 'en';
            let scanner = null;

            // --- LANGUAGE TRANSLATIONS (i18n) ---
            const translations = {
                en: {
                    app_title: 'Building Info Hub',
                    scan_qr_code: 'Scan QR',
                    search_by_zip: 'Search by Postal/Zip Code...',
                    add_new_building: 'Add New Building',
                    import_excel: 'Import Excel',
                    export_excel: 'Export Excel',
                    no_buildings_found: 'No buildings found. Add one to get started!',
                    building_name: 'Building Name',
                    address: 'Address',
                    zip_code: 'Postal / Zip Code',
                    notes: 'Notes',
                    photo: 'Photo',
                    location: 'Location',
                    capture_location: 'Capture Location',
                    location_captured: 'Location Captured',
                    cancel: 'Cancel',
                    save: 'Save',
                    back_to_list: 'Back to List',
                    edit: 'Edit',
                    delete: 'Delete',
                    export_pdf: 'Export PDF',
                    scan_instruction: "Point your camera at a building's QR code.",
                    delete_confirm_title: 'Confirm Deletion',
                    delete_confirm_text: 'Are you sure you want to delete this building record? This action cannot be undone.',
                    view_details: 'View Details',
                    pdf_title: 'Building Information',
                },
                fa: {
                    app_title: 'Ù…Ø±Ú©Ø² Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³Ø§Ø®ØªÙ…Ø§Ù†',
                    scan_qr_code: 'Ø§Ø³Ú©Ù† QR',
                    search_by_zip: 'Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ Ú©Ø¯ Ù¾Ø³ØªÛŒ...',
                    add_new_building: 'Ø§ÙØ²ÙˆØ¯Ù† Ø³Ø§Ø®ØªÙ…Ø§Ù† Ø¬Ø¯ÛŒØ¯',
                    import_excel: 'ÙˆØ±ÙˆØ¯ Ø§Ø² Ø§Ú©Ø³Ù„',
                    export_excel: 'Ø®Ø±ÙˆØ¬ Ø¨Ù‡ Ø§Ú©Ø³Ù„',
                    no_buildings_found: 'Ù‡ÛŒÚ† Ø³Ø§Ø®ØªÙ…Ø§Ù†ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯. Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ ÛŒÚ©ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯!',
                    building_name: 'Ù†Ø§Ù… Ø³Ø§Ø®ØªÙ…Ø§Ù†',
                    address: 'Ø¢Ø¯Ø±Ø³',
                    zip_code: 'Ú©Ø¯ Ù¾Ø³ØªÛŒ',
                    notes: 'ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§',
                    photo: 'Ø¹Ú©Ø³',
                    location: 'Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ú©Ø§Ù†ÛŒ',
                    capture_location: 'Ø«Ø¨Øª Ù…ÙˆÙ‚Ø¹ÛŒØª',
                    location_captured: 'Ù…ÙˆÙ‚Ø¹ÛŒØª Ø«Ø¨Øª Ø´Ø¯',
                    cancel: 'Ø§Ù†ØµØ±Ø§Ù',
                    save: 'Ø°Ø®ÛŒØ±Ù‡',
                    back_to_list: 'Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„ÛŒØ³Øª',
                    edit: 'ÙˆÛŒØ±Ø§ÛŒØ´',
                    delete: 'Ø­Ø°Ù',
                    export_pdf: 'Ø®Ø±ÙˆØ¬ÛŒ PDF',
                    scan_instruction: 'Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù‡ Ø³Ù…Øª Ú©Ø¯ QR Ø³Ø§Ø®ØªÙ…Ø§Ù† Ø¨Ú¯ÛŒØ±ÛŒØ¯.',
                    delete_confirm_title: 'ØªØ§ÛŒÛŒØ¯ Ø­Ø°Ù',
                    delete_confirm_text: 'Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø³Ø§Ø®ØªÙ…Ø§Ù† Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„ ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³Øª.',
                    view_details: 'Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª',
                    pdf_title: 'Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³Ø§Ø®ØªÙ…Ø§Ù†',
                }
            };
            
            // --- PWA SERVICE WORKER REGISTRATION ---
            // The following Service Worker registration code has been disabled.
            // The execution environment throws an error because it does not support
            // registering a Service Worker from a 'blob:' URL. This is a security
            // restriction in this specific sandboxed environment.
            // While this means the app won't work offline in this preview,
            // the rest of its functionality will work as expected. In a real-world
            // deployment, you would use a separate `sw.js` file.
            /*
            if ('serviceWorker' in navigator) {
                const swContent = `
                    const CACHE_NAME = 'bim-hub-cache-v1';
                    const urlsToCache = [
                        '${location.href}',
                        'https://cdn.tailwindcss.com/',
                        'https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js',
                        'https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js',
                        'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js',
                        'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
                        'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js'
                    ];

                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                            .then(cache => {
                                console.log('Opened cache');
                                return cache.addAll(urlsToCache);
                            })
                        );
                    });

                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.match(event.request)
                            .then(response => {
                                return response || fetch(event.request);
                            })
                        );
                    });

                    self.addEventListener('activate', event => {
                        const cacheWhitelist = [CACHE_NAME];
                        event.waitUntil(
                            caches.keys().then(cacheNames => {
                                return Promise.all(
                                    cacheNames.map(cacheName => {
                                        if (cacheWhitelist.indexOf(cacheName) === -1) {
                                            return caches.delete(cacheName);
                                        }
                                    })
                                );
                            })
                        );
                    });
                `;
                
                try {
                    const blob = new Blob([swContent], { type: 'application/javascript' });
                    const swURL = URL.createObjectURL(blob);

                    window.addEventListener('load', () => {
                        navigator.serviceWorker.register(swURL)
                            .then(reg => console.log('Service Worker registered successfully.', reg))
                            .catch(err => console.error('Service Worker registration failed:', err));
                    });
                } catch (e) {
                     console.error('Failed to create service worker blob:', e);
                }
            }
            */


            // --- DATABASE (INDEXEDDB) SETUP ---
            function initDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('BuildingHubDB', 1);
                    request.onerror = (event) => reject('Database error: ' + event.target.errorCode);
                    request.onsuccess = (event) => {
                        db = event.target.result;
                        console.log('Database opened successfully.');
                        resolve(db);
                    };
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        const objectStore = db.createObjectStore('buildings', { keyPath: 'id', autoIncrement: true });
                        objectStore.createIndex('zipCode', 'zipCode', { unique: false });
                        console.log('Database upgrade complete.');
                    };
                });
            }
            
            // --- CRUD (Create, Read, Update, Delete) OPERATIONS ---
            function addBuilding(building) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['buildings'], 'readwrite');
                    const store = transaction.objectStore('buildings');
                    const request = store.add(building);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            function getBuildings() {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['buildings'], 'readonly');
                    const store = transaction.objectStore('buildings');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }
            
            function getBuildingById(id) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['buildings'], 'readonly');
                    const store = transaction.objectStore('buildings');
                    const request = store.get(id);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            function updateBuilding(building) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['buildings'], 'readwrite');
                    const store = transaction.objectStore('buildings');
                    const request = store.put(building);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            function deleteBuilding(id) {
                 return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['buildings'], 'readwrite');
                    const store = transaction.objectStore('buildings');
                    const request = store.delete(id);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }

            // --- UI RENDERING & NAVIGATION ---
            function switchPage(pageId) {
                Object.values(pages).forEach(p => p.classList.remove('active'));
                if (pages[pageId]) {
                    pages[pageId].classList.add('active');
                }
                 // Stop scanner when leaving scanner page
                if (pageId !== 'scanner' && scanner) {
                    stopScanner();
                }
            }
            
            function updateLanguage() {
                const lang = translations[currentLanguage];
                document.documentElement.lang = currentLanguage;
                appContainer.classList.toggle('persian', currentLanguage === 'fa');

                document.querySelectorAll('[data-lang]').forEach(el => {
                    const key = el.getAttribute('data-lang');
                    if (lang[key]) {
                        el.textContent = lang[key];
                    }
                });
                 document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
                    const key = el.getAttribute('data-lang-placeholder');
                    if (lang[key]) {
                        el.placeholder = lang[key];
                    }
                });
            }
            
            async function renderBuildingList(filter = '') {
                const buildings = await getBuildings();
                buildingList.innerHTML = '';
                
                const filteredBuildings = buildings.filter(b => 
                    b.zipCode.toLowerCase().includes(filter.toLowerCase()) || 
                    b.name.toLowerCase().includes(filter.toLowerCase())
                );
                
                if (filteredBuildings.length === 0) {
                    emptyListMsg.style.display = 'block';
                } else {
                    emptyListMsg.style.display = 'none';
                    filteredBuildings.forEach(building => {
                        const card = document.createElement('div');
                        card.className = 'card cursor-pointer hover:shadow-xl hover:-translate-y-1 transition-all';
                        card.dataset.id = building.id;
                        
                        const photoUrl = building.photoData ? building.photoData : 'https://placehold.co/400x300/3498db/ffffff?text=Building';

                        card.innerHTML = `
                            <img src="${photoUrl}" alt="${building.name}" class="w-full h-48 object-cover">
                            <div class="p-4">
                                <h3 class="font-bold text-lg">${building.name}</h3>
                                <p class="text-gray-600 dark:text-gray-400">${building.address}</p>
                                <p class="text-sm font-semibold text-blue-500 mt-2">${building.zipCode}</p>
                            </div>
                        `;
                        card.addEventListener('click', () => showDetailView(building.id));
                        buildingList.appendChild(card);
                    });
                }
            }
            
            async function showDetailView(id) {
                const building = await getBuildingById(id);
                if (!building) return;
                
                currentBuildingId = id;
                const photoUrl = building.photoData ? building.photoData : 'https://placehold.co/400x300/3498db/ffffff?text=Building';
                const locationLink = building.location ? `https://www.google.com/maps?q=${building.location.lat},${building.location.lon}` : '#';
                const locationText = building.location ? `${building.location.lat.toFixed(5)}, ${building.location.lon.toFixed(5)}` : 'Not available';

                const detailHtml = `
                     <div class="flex flex-col md:flex-row gap-6">
                        <div class="md:w-1/2">
                            <img src="${photoUrl}" alt="${building.name}" class="w-full h-auto rounded-lg shadow-md object-cover">
                        </div>
                        <div class="md:w-1/2 flex flex-col">
                            <h2 class="text-3xl font-bold mb-2">${building.name}</h2>
                            <p class="text-lg text-gray-500 dark:text-gray-400 mb-4">${building.address}</p>
                            <p class="mb-4"><strong data-lang="zip_code">Zip Code:</strong> ${building.zipCode}</p>
                            <p class="mb-4"><strong data-lang="notes">Notes:</strong><br>${building.notes || 'N/A'}</p>
                             <p class="mb-4"><strong data-lang="location">Location:</strong> <a href="${locationLink}" target="_blank" class="text-blue-500 hover:underline">${locationText}</a></p>
                            <div class="mt-auto pt-4 flex justify-center" id="qr-code-container"></div>
                        </div>
                    </div>
                `;
                detailContent.innerHTML = detailHtml;
                
                // Generate QR Code
                const qrContainer = detailContent.querySelector('#qr-code-container');
                qrContainer.innerHTML = ''; // Clear previous QR
                new QRCode(qrContainer, {
                    text: `BIM_HUB_BUILDING_ID::${building.id}`,
                    width: 128,
                    height: 128,
                    colorDark : "#ffffff",
                    colorLight : "#2c3e50",
                });
                
                switchPage('detail');
                updateLanguage();
            }
            
            // --- EVENT LISTENERS & HANDLERS ---
            addBuildingBtn.addEventListener('click', () => {
                formTitle.textContent = translations[currentLanguage].add_new_building;
                buildingForm.reset();
                buildingIdInput.value = '';
                photoPreview.src = '';
                photoPreview.style.display = 'none';
                locationDisplay.textContent = '';
                currentLocation = null;
                currentPhotoData = null;
                switchPage('form');
            });
            
            cancelFormBtn.addEventListener('click', () => switchPage('list'));

            buildingForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = buildingIdInput.value ? parseInt(buildingIdInput.value) : null;
                
                const buildingData = {
                    name: buildingNameInput.value,
                    address: addressInput.value,
                    zipCode: zipCodeInput.value,
                    notes: notesInput.value,
                    photoData: currentPhotoData,
                    location: currentLocation
                };

                if (id) {
                    buildingData.id = id;
                    await updateBuilding(buildingData);
                } else {
                    await addBuilding(buildingData);
                }
                
                await renderBuildingList();
                switchPage('list');
            });

            photoInput.addEventListener('change', () => {
                const file = photoInput.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        currentPhotoData = e.target.result;
                        photoPreview.src = currentPhotoData;
                        photoPreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });

            getLocationBtn.addEventListener('click', () => {
                if ('geolocation' in navigator) {
                    getLocationBtn.disabled = true;
                    getLocationBtn.textContent = '...';
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            currentLocation = {
                                lat: position.coords.latitude,
                                lon: position.coords.longitude
                            };
                            locationDisplay.textContent = `${translations[currentLanguage].location_captured}: ${currentLocation.lat.toFixed(4)}, ${currentLocation.lon.toFixed(4)}`;
                            getLocationBtn.disabled = false;
                            updateLanguage();
                        },
                        (error) => {
                            alert(`Error getting location: ${error.message}`);
                            getLocationBtn.disabled = false;
                            updateLanguage();
                        }
                    );
                } else {
                    alert('Geolocation is not supported by your browser.');
                }
            });

            backToListBtn.addEventListener('click', () => switchPage('list'));

            editBuildingBtn.addEventListener('click', async () => {
                const building = await getBuildingById(currentBuildingId);
                formTitle.textContent = translations[currentLanguage].edit + ' ' + building.name;
                buildingIdInput.value = building.id;
                buildingNameInput.value = building.name;
                addressInput.value = building.address;
                zipCodeInput.value = building.zipCode;
                notesInput.value = building.notes;
                currentPhotoData = building.photoData;
                photoPreview.src = currentPhotoData || '';
                photoPreview.style.display = currentPhotoData ? 'block' : 'none';
                currentLocation = building.location;
                if(currentLocation) {
                    locationDisplay.textContent = `${translations[currentLanguage].location_captured}: ${currentLocation.lat.toFixed(4)}, ${currentLocation.lon.toFixed(4)}`;
                } else {
                    locationDisplay.textContent = '';
                }
                switchPage('form');
            });
            
            deleteBuildingBtn.addEventListener('click', async () => {
                const lang = translations[currentLanguage];
                if (confirm(`${lang.delete_confirm_title}\n\n${lang.delete_confirm_text}`)) {
                    await deleteBuilding(currentBuildingId);
                    await renderBuildingList();
                    switchPage('list');
                }
            });
            
            searchBar.addEventListener('input', (e) => {
                renderBuildingList(e.target.value);
            });
            
            toggleLangBtn.addEventListener('click', () => {
                currentLanguage = currentLanguage === 'en' ? 'fa' : 'en';
                updateLanguage();
            });

            // --- QR CODE SCANNER ---
            function startScanner() {
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    switchPage('scanner');
                    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                        .then(stream => {
                            scannerVideo.srcObject = stream;
                            scannerVideo.play();
                            requestAnimationFrame(tick);
                        })
                        .catch(err => {
                            console.error("Error accessing camera: ", err);
                            alert("Could not access camera. Please grant permission.");
                            switchPage('list');
                        });
                }
            }
            
            function stopScanner() {
                if (scannerVideo.srcObject) {
                    scannerVideo.srcObject.getTracks().forEach(track => track.stop());
                    scannerVideo.srcObject = null;
                }
            }

            function tick() {
                if (scannerVideo.readyState === scannerVideo.HAVE_ENOUGH_DATA) {
                    const canvasElement = document.createElement('canvas');
                    const canvas = canvasElement.getContext('2d');
                    canvasElement.height = scannerVideo.videoHeight;
                    canvasElement.width = scannerVideo.videoWidth;
                    canvas.drawImage(scannerVideo, 0, 0, canvasElement.width, canvasElement.height);
                    const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "dontInvert",
                    });

                    if (code && code.data.startsWith('BIM_HUB_BUILDING_ID::')) {
                        stopScanner();
                        const id = parseInt(code.data.split('::')[1]);
                        showDetailView(id);
                        return; // Stop the loop
                    }
                }
                requestAnimationFrame(tick);
            }

            scanQrBtn.addEventListener('click', startScanner);
            cancelScanBtn.addEventListener('click', () => {
                stopScanner();
                switchPage('list');
            });
            
            // --- EXCEL IMPORT/EXPORT ---
            exportExcelBtn.addEventListener('click', async () => {
                const buildings = await getBuildings();
                const dataToExport = buildings.map(b => ({
                    ID: b.id,
                    Name: b.name,
                    Address: b.address,
                    ZipCode: b.zipCode,
                    Notes: b.notes,
                    Latitude: b.location?.lat,
                    Longitude: b.location?.lon
                }));
                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Buildings");
                XLSX.writeFile(workbook, "Building_Information_Export.xlsx");
            });

            importExcelBtn.addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = ".xlsx, .xls";
                input.onchange = e => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const json = XLSX.utils.sheet_to_json(worksheet);

                        for(const item of json) {
                            const buildingData = {
                                name: item.Name,
                                address: item.Address,
                                zipCode: String(item.ZipCode),
                                notes: item.Notes,
                                location: (item.Latitude && item.Longitude) ? {lat: item.Latitude, lon: item.Longitude} : null,
                                photoData: null // Photos cannot be imported this way
                            };
                            await addBuilding(buildingData);
                        }
                        alert(`${json.length} records imported successfully!`);
                        await renderBuildingList();
                    };
                    reader.readAsArrayBuffer(file);
                };
                input.click();
            });

            // --- PDF EXPORT ---
            exportPdfBtn.addEventListener('click', async () => {
                const { jsPDF } = window.jspdf;
                const building = await getBuildingById(currentBuildingId);
                const lang = translations[currentLanguage];

                // For PDF, we need to load fonts that support the characters
                // jsPDF has built-in fonts but they don't support Persian.
                // This is a complex topic. For this demo, we'll use a simplified text approach.
                // For a real app, you'd embed a font like Vazirmatn into the PDF.

                const doc = new jsPDF();
                
                doc.setFontSize(22);
                doc.text(lang.pdf_title, 10, 20);

                doc.setFontSize(16);
                doc.text(building.name, 10, 35);

                doc.setFontSize(12);
                let y = 50;
                
                function addText(label, value) {
                    if (!value) return;
                    // jsPDF doesn't handle RTL well out of the box. This is a workaround.
                    if(currentLanguage === 'fa') {
                        doc.text(value, 200, y, { align: 'right' });
                        doc.text(label, 10, y);
                    } else {
                         doc.text(`${label}: ${value}`, 10, y);
                    }
                    y += 10;
                }

                addText(lang.address, building.address);
                addText(lang.zip_code, building.zipCode);
                
                // Handle multiline notes
                const notesLines = doc.splitTextToSize(building.notes || '', 180);
                addText(lang.notes, '');
                doc.text(notesLines, 10, y);
                y += (notesLines.length * 5); // adjust space for notes

                if (building.location) {
                    addText(lang.location, `${building.location.lat.toFixed(5)}, ${building.location.lon.toFixed(5)}`);
                }
                
                if (building.photoData) {
                    try {
                        // The image needs to be in a supported format (JPEG/PNG) for jsPDF
                        const img = new Image();
                        img.src = building.photoData;
                        // wait for image to load to get dimensions
                        await new Promise(resolve => img.onload = resolve);
                        
                        const imgProps = doc.getImageProperties(img);
                        const imgWidth = 100;
                        const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

                        if (y + imgHeight > 280) { // Check if it fits on page
                            doc.addPage();
                            y = 20;
                        }
                        doc.addImage(img, 'PNG', 10, y, imgWidth, imgHeight);
                    } catch (e) {
                        console.error("Could not add image to PDF:", e);
                        addText("Photo", "Could not be rendered in PDF.");
                    }
                }
                
                doc.save(`${building.name}_Info.pdf`);
            });


            // --- INITIALIZATION ---
            async function main() {
                await initDB();
                await renderBuildingList();
                updateLanguage();
                switchPage('list');
            }

            main();
        })();
    </script>
</body>
</html>
